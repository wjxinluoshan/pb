<html>
<head>
    <meta charset="UTF-8">
    <title>编辑照片</title>
    <link type="images/x-icon" rel="shortcut icon" href="/pb/imgs/blog_icon.png">
    <!--   VUE-->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!--  jQuery-->
    <script src="/pb/js/jquery-3.4.1.min.js"></script>
    <script src="/pb/js/constants.js"></script>
    <script src="/pb/js/ownerVerify.js"></script>
    <script src="/pb/js/showOrHiddenLoadingDiv.js"></script>
    <link rel="stylesheet" type="text/css" href="/pb/css/showPictureTable.css">
    <link rel="stylesheet" type="text/css" href="/pb/css/loadingDiv.css">
<!--
<link type="images/x-icon" rel="shortcut icon" href="/pblog/imgs/blog_icon.png">
    <script src="/pblog/js/jquery-3.4.1.min.js"></script>
    <script src="/pblog/js/constants.js"></script>
    <script src="/pblog/js/ownerVerify.js"></script>
    <script src="/pblog/js/showOrHiddenLoadingDiv.js"></script>
    <link rel="stylesheet" type="text/css" href="/pblog/css/showPictureTable.css">
    <link rel="stylesheet" type="text/css" href="/pblog/css/loadingDiv.css">
-->
    <style>
        .main_div {
            width: 70%;
            height: max-content;
            background: #99D9EA;
            margin-left: 50%;
            transform: translateX(-50%);
            margin-top: 1%;
            border-radius: 30px;
        }

        /*选择照片的input*/
        .choice_photos_input {
            margin-left: 50%;
            margin-top: 2%;
            transform: translateX(-50%);
        }

        .upload_pictures_button {
            border: 0;
            border-radius: 5px;
            width: 10%;
            height: 30px;
            text-align: center;
            margin-top: 5%;
        }

        .upload_pictures_button:hover {
            background: aquamarine;
        }

        .upload_pictures_button:active {
            background: #C6587B;
        }

    </style>
</head>
<body style="background: #C6587B">
<div class="loading_div" id="loading_div">
    <div></div>
    <img src="/pb/imgs/loading.gif"/></div>
<h1 style="text-align: center">照片操作</h1>
<div class="main_div">
    <input id='choice_photos_input' class="choice_photos_input" type="file" accept="image/jpeg,image/png"
           multiple/><br>
    <button class="choice_photos_input upload_pictures_button" id="upload_pictures_button">上传</button>
    <br>
    <button style="width: max-content" class="choice_photos_input upload_pictures_button"
            id="view_stored_pictures_button">操作已存照片
    </button>
    <table class="show_pictures_table" id="show_pictures_table">
    </table>
</div>
</body>
<script src="/pb/js/createShowPictureTable.js"></script>
<!--
<script src="/pblog/js/createShowPictureTable.js"></script>
-->
<script>
    //onChange会根据本次选择和上次选择的file进行比较相同则不执行，当
    //一次性删除完上次选择的照片后就应该将 input  value值设置为''
    document.getElementById('choice_photos_input').onchange = function () {
        var resultFiles = this.files;
        var canShowNumber = 0;
        var resultFileIndex = 0;
        showOrHiddenLoadingDiv(true);
        /**
         * 使用promise异步加载
         * @type {Promise}
         */
        setTimeout(() => {
            var promise = new Promise(function (resolve, reject) {
                for (var i = 0; i < resultFiles.length; i++) {
                    var reader = new FileReader();
                    //文件内容的加载是异步的所以说加载序列可能不同
                    reader.tag = i;
                    reader.onload = function () {
                        //如果几经选择不执行添加操作
                        if (choosedPicturesUrlFromLocal.indexOf(this.result) !== -1) {
                            resultFileIndex++;
                            return;
                        }
                        //添加照片
                        choosedPicturesUrlFromLocal.push(this.result);
                        choosedPicturesNameFromLocal.push(resultFiles[this.tag].name);
                        canShowNumber++;
                        resultFileIndex++;
                        if (resultFileIndex === resultFiles.length) {
                            createImgTag(choosedPicturesUrlFromLocal.length - canShowNumber);
                            showOrHiddenLoadingDiv(false);
                            canUpload = true;
                        }
                    };
                    reader.readAsDataURL(resultFiles[i]);
                }
            });
            //加载失败
            promise.catch(function (reason) {
                showOrHiddenLoadingDiv(false);
                alert(reason)
            })
        }, 100);
    };

    var data = '';
    var uploadAjax = '';
    var uploadFunc = function () {
        showOrHiddenLoadingDiv(true);
        //上传操作
        if (uploadAjax)
            uploadAjax.abort();
        uploadAjax = $.ajax({
            method: 'POST',
            url: '/pb/data/uploadPictures',
            data: {data: data},
            dataType: 'text',
            success: function (data) {
                showOrHiddenLoadingDiv(false);
                if (data === FAILURE) {
                    if (confirm("上传失败是否需要重新上传？"))
                        uploadFunc();
                }
                //返回成功
                alert('上传成功!!!');
                //是否要去别的页面暂时未定？？？？？
                window.location.href = '/pb/owner/ownerMain.html';
                canUpload = false;
            }
        }).fail(function () {
            showOrHiddenLoadingDiv(false);
            if (confirm("网络请求失败，是否要重新请求？")) {
                canUpload = false;
                uploadFunc();
            }
        });
    };
    /**
     * 上传图片
     */
    $('#upload_pictures_button').on('click', function () {
        if (choosedPicturesNameFromLocal.length === 0) {
            alert("您还没选要上传的照片!!!");
            return;
        }
        if (canUpload) {
            for (var index = 0; index < choosedPicturesUrlFromLocal.length; index++) {
                data += (choosedPicturesUrlFromLocal[index] + ' pblog ' + choosedPicturesNameFromLocal[index] + ' pblog ');
            }
            data = data.substring(0, data.length - 7);
            uploadFunc();
        } else {
            alert('图片正在加载中，请稍等!!!');
        }
    });


    /**
     * 查看已存照片
     */
    var loadMorePromptLi;
    var loadPictureAjax;
    //想要删除的照片的集合
    var wantDeletePicturesUrlArray = [];
    var thePhotoCurrentPageIndex = 1;
    var ul = document.createElement('ul');
    ul.style.width = '90%';
    ul.style.height = 'max-length';
    var termalLoadingPicture = function () {
        showOrHiddenLoadingDiv(true);
        if (loadPictureAjax)
            loadPictureAjax.abort();
        loadPictureAjax = $.ajax({
            method: 'POST',
            url: '/pb/data/getPicturesInfo',
            data: {pageNumber: thePhotoCurrentPageIndex.toString()},
            dataType: 'text',
            success: function (data) {
                showOrHiddenLoadingDiv(false);
                if (data === FAILURE) {
                    if (confirm("数据加载失败，是否重新？？？")) {
                        termalLoadingPicture();
                    } else {
                        if (thePhotoCurrentPageIndex === 1) {
                            $('#view_stored_pictures_button').html('操作已存照片');
                            $('#show_stored_pictures_div').remove();
                            //  thePhotoCurrentPageIndex = 1;
                            if (document.getElementById('load_more_span'))
                                document.getElementById('load_more_span').innerHTML = "点击加载更多..."
                        } else {
                            if (document.getElementById('load_more_span'))
                                document.getElementById('load_more_span').innerHTML = "点击加载更多..."
                        }
                    }
                    return
                }
                //返回的形式  pictureUrl，pictureName，pictureUrl....
                //加载完成后指示下一页picture
                thePhotoCurrentPageIndex++;
                var dataArr = data.split(' pblog ');
                for (var index = 0; index < dataArr.length; index++) {
                    if (index % 2 !== 0) {
                        var li = document.createElement('li');
                        li.style.textAlign = "center";
                        li.style.listStyleType = 'none';
                        //设置li的id为了删除
                        var i = index;
                        li.setAttribute('id', i.toString());
                        var img = document.createElement('img');
                        img.style.width = '40%';
                        img.setAttribute('src', dataArr[index - 1]);
                        img.setAttribute('alt', dataArr[index]);
                        img.tag = i;
                        img.onclick = function () {
                            if (confirm('确认删除该照片吗?')) {
                                wantDeletePicturesUrlArray.push(this.getAttribute('src'));
                                $('#' + this.tag).remove();
                            }
                        };
                        var span = document.createElement('span');
                        span.innerHTML = dataArr[index];
                        li.append(img);
                        li.append(document.createElement('br'));
                        li.append(span);
                        ul.append(li);
                    }
                }
                //删除加载更多的li
                if (loadMorePromptLi) {
                    loadMorePromptLi.remove();
                    loadMorePromptLi = '';
                }
                if (thePhotoCurrentPageIndex === 2) {
                    let show_stored_pictures_div = $('#show_stored_pictures_div');
                    if (show_stored_pictures_div) {
                        if (show_stored_pictures_div[0].scrollTop + show_stored_pictures_div.height() >= show_stored_pictures_div[0].scrollHeight) {
                            mCreateLoadMoreSpanFunc();
                        }
                    }
                }
                /*
                 *避免重复创建
                 */
                if (thePhotoCurrentPageIndex - 1 === 1)
                    $('#show_stored_pictures_div').append(ul);
            }

        }).fail(function () {
            showOrHiddenLoadingDiv(false);
            if (confirm("网络请求失败，是否要重新请求？")) {
                termalLoadingPicture();
            }
        });
    };

    //删除照片的ajax
    var deletePicturesAjax;
    //删除照片的参数
    var deletePictruesData = '';
    //删除照片的请求
    var deletePictureCmd = function () {
        if (wantDeletePicturesUrlArray.length === 0)
            return;
        if (!deletePictruesData) {
            //整理参数：   url,url....
            for (var index = 0; index < wantDeletePicturesUrlArray.length; index++) {
                if (index + 1 !== wantDeletePicturesUrlArray.length)
                    deletePictruesData += (wantDeletePicturesUrlArray[index] + ' pblog ');
                else
                    deletePictruesData += wantDeletePicturesUrlArray[index];
            }
        }
        showOrHiddenLoadingDiv(true);
        if (deletePicturesAjax)
            deletePicturesAjax.abort();
        deletePicturesAjax = $.ajax({
            method: 'POST',
            url: '/pb/data/deletePicturesInfo',
            data: {data: deletePictruesData},
            dataType: 'text',
            success: function (data) {
                showOrHiddenLoadingDiv(false);
                if (data === SUCCESS) {
                    wantDeletePicturesUrlArray.length = 0;
                    deletePictruesData = '';
                    alert('删除操作完成!!!')
                } else if (data === FAILURE) {
                    if (confirm('删除操作失败，重新请求操作？')) {
                        deletePictureCmd()
                    }
                } else {
                    wantDeletePicturesUrlArray.length = 0;
                    deletePictruesData = '';
                    alert('部分删除操作完成!!!')
                }
            }
        }).fail(function () {
            showOrHiddenLoadingDiv(false);
            if (confirm("网络请求失败，是否要重新请求？")) {
                deletePictureCmd();
            }else {
                wantDeletePicturesUrlArray.length = 0;
                deletePictruesData = '';
            }
        })

    };
    /**
     *显示已经保存的照片
     */
    var mCreateLoadMoreSpanFunc = function () {
        let li = document.createElement('li');
        li.style.textAlign = "center";
        li.style.listStyleType = 'none';
        li.setAttribute('id', 'load_more');
        let span = document.createElement('span');
        span.setAttribute('id', 'load_more_span');
        span.innerHTML = '点击加载更多...';
        /*
         * 进行热加载：
         *    1.先加载一部分数据，此时记住该id或者说按照页数进行查询；
         *    2.当查询完毕后拖拽进行进一步加载
         */
        span.onclick = function (ev) {
            if (this.innerHTML === '点击加载更多...') {
                this.innerHTML = '正在加载中...';
                termalLoadingPicture();
            }
        };
        li.append(span);
        ul.append(li);
        loadMorePromptLi = li;
    };
    $('#view_stored_pictures_button').on('click', function () {
        if ($(this).html().includes('操作已存照片')) {
            //清空删除照片数组
            wantDeletePicturesUrlArray.length = 0;
            $(this).html('完成操作');
            var showStoredPicturesDiv = document.createElement("div");
            showStoredPicturesDiv.setAttribute('class', 'show_stored_pictures_div');
            showStoredPicturesDiv.setAttribute('id', 'show_stored_pictures_div');
            $('body').append(showStoredPicturesDiv);
            $('#show_stored_pictures_div').css({
                'position': 'absolute',
                'z-index': '100',
                'width': '40%',
                'height': '50%',
                'margin-left': '50%',
                'top': '255px',
                'transform': 'translateX(-50%)',
                'border-radius': '10px',
                'background': 'white',
                'overflow-y': 'auto',
                'text-align': 'center'
            });
            //监听div的滚动事件
            // 滚动距离总长(注意不是滚动条的长度)
            let nScrollHeight = 0;
            //滚动到的当前位置
            let nScrollTop = 0;
            let show_stored_pictures_div = $('#show_stored_pictures_div');
            let nDivHeight = $("#show_stored_pictures_div").height();
            show_stored_pictures_div.scroll(function () {
                if (!loadMorePromptLi) {
                    //滚动的距离
                    nScrollHeight = $(this)[0].scrollHeight;
                    //滚动条距离top的距离
                    nScrollTop = $(this)[0].scrollTop;
                    //当滑动到底部时，添加一个标签，点击加载下一页
                    if (nScrollTop + nDivHeight >= nScrollHeight) {
                        mCreateLoadMoreSpanFunc();
                    }
                }
            });
            termalLoadingPicture();
        } else {
            $(this).html('操作已存照片');
            $('#show_stored_pictures_div').remove();
            thePhotoCurrentPageIndex = 1;
            ul = document.createElement('ul');
            ul.style.width = '90%';
            ul.style.height = 'max-length';            //进行删除操作
            deletePictureCmd()
        }
    });
</script>
</html>