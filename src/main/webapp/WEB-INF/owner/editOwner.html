<html>
<head>
    <meta charset="UTF-8">
    <title>编辑我的信息</title>
    <link type="images/x-icon" rel="shortcut icon" href="/imgs/blog_icon.png">
    <link rel="stylesheet" type="text/css" href="/css/loadingDiv.css">
    <!--   VUE-->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!--  jQuery-->
    <script src="/js/jquery-3.4.1.min.js"></script>
    <script src="/js/constants.js"></script>
    <script src="/js/ownerVerify.js"></script>
    <script src="/js/showOrHiddenLoadingDiv.js"></script>
<!--
<link type="images/x-icon" rel="shortcut icon" href="/pblog/imgs/blog_icon.png">
    <link rel="stylesheet" type="text/css" href="/pblog/css/loadingDiv.css">
    <script src="/pblog/js/jquery-3.4.1.min.js"></script>
    <script src="/pblog/js/constants.js"></script>
    <script src="/pblog/js/ownerVerify.js"></script>
    <script src="/pblog/js/showOrHiddenLoadingDiv.js"></script>
-->
    <style>
        #edit_div {
            display: none;
            width: 40%;
            height: 80%;
            background: cadetblue;
            margin-left: 50%;
            margin-top: 5%;
            border-radius: 10%;
            transform: translate(-50%, 0);
        }

        #mylogo_img {
            margin-top: 5%;
            width: 15%;
            height: 16%;
            border-radius: 15px;
            border: 1px dotted #000;
            margin-left: 50%;
            transform: translate(-50%, 0);
        }

        #introduce_self_textarea {
            width: 30%;
            height: 50%;
            background: #99D9EA;
            border-radius: 10%;
            margin-left: 2%;
            margin-top: 3%;
        }

        #habit_textArea {
            float: right;
            background: #99D9EA;
            width: 30%;
            height: 50%;
            border-radius: 10%;
            margin-right: 2%;
            margin-top: 3%;
        }

        #commit_button {
            font-size: 5vm;
            width: 10%;
            height: 5%;
            margin-top: 2%;
            margin-left: 50%;
            transform: translateX(-50%);
        }
    </style>
</head>
<body style="background: #C6587B">
<div class="loading_div" id="loading_div">
    <div></div>
    <img src="/imgs/loading.gif"/></div>
<div id="edit_div">
    <img id="mylogo_img" @click="setImgSrc()"/>
    </br>
    <span style="width:100%;height:5%;display: block;background: beige;margin-top: 3%">
        <span style="margin-left: 13%">简介：</span>
        <span style="margin-left: 55%">喜好：</span>
    </span>
    <textarea id="introduce_self_textarea">
    </textarea>
    <textarea id="habit_textArea">
    </textarea>
    </br>
    <input id="commit_button" type="button" value="提交" @click='commitCmd()'/>
</div>
</body>
<script>
    /**
     *owner信息数据的加载
     */
        //存放加载的用户信息
    var userInfo = [];
    var loadAjax = "";
    /**
     *获取用户数据
     */
    var requestUserInfo = function () {
        if (loadAjax)
            loadAjax.abort();
        loadAjax = $.ajax({
            method: 'POST',
            url: 'http://' + IP + ':' + PORT_PATH + '/userInfo/userInfoRequire',
            dataType: 'text',
            success: function (data) {
                if (data === FAILURE) {
                    if (confirm("数据加载失败可能还没相关信息，是否要重新加载？")) {
                        requestUserInfo();
                        return;
                    } else {
                        return
                    }
                }
                //成功
                userInfo = data.split(" pblog ");
                //设置profile img
                $('#mylogo_img').attr('src', userInfo[0]);
                choiceLogoURL = userInfo[0];
                $('#introduce_self_textarea').val(userInfo[1]);
                $('#habit_textArea').val(userInfo[2]);
            }
        }).fail(function () {
            if (confirm("网络请求失败，是否要重新请求？")) {
                requestUserInfo();
            }
        });
    };
    requestUserInfo();

    //淡入动画
    $('#edit_div').fadeIn(2000);

    /**
     * 变量区
     */
    var choiceLogoURL = "";
    var mSuccessed = "0";
    var mFailure = "1";

    /**
     * 图像处理
     */
    var profile = new Vue({
        el: '#mylogo_img',
        methods: {
            //打开文本选择器，进行图片的选择
            setImgSrc: function () {
                if (document.getElementById("_ef")) {
                    document.getElementById("_ef").remove();
                }
                var inputObj = document.createElement('input');
                inputObj.setAttribute('id', '_ef');
                inputObj.setAttribute('type', 'file');
                //设置input所选取文件的为图片
                inputObj.setAttribute("accept", "image/png,image/jpeg");
                inputObj.setAttribute("style", 'visibility:hidden');
                document.body.appendChild(inputObj);
                inputObj.click();
                //进行图片的选择
                inputObj.onchange = function (event) {
                    var resultFile = inputObj.files[0];
                    if (resultFile) {

                        //将图像转换成可以预览的
                        var reader = new FileReader();
                        reader.onload = function (e) {
                            var urlData = choiceLogoURL = profileBinaryData = this.result;
                            //预览图片
                            $('#mylogo_img').attr("src", urlData);
                            //上传photo：去除将photo Base64编码后的头
                            // if (profileBinaryData.includes('image/jpeg'))
                            //     profileBinaryData = profileBinaryData.replace('data:image/jpeg;base64,', '');
                            // else if (profileBinaryData.includes('image/png'))
                            //     profileBinaryData = profileBinaryData.replace('data:image/png;base64,', '');
                        };
                        reader.readAsDataURL(resultFile);
                    }
                    $("#_ef").remove();
                }
            }
        }
    });

    /**
     * 提交按钮
     */
    var commit_button = new Vue({
        el: '#commit_button',
        methods: {
            commitCmd: function () {
                //是否选择了logo
                if (!choiceLogoURL) {
                    alert('请您选择设置一个图像!!!');
                    return;
                }
                //检测简介和喜好
                if (!$('#introduce_self_textarea').val().trim()) {
                    alert('请输入您的简介!!!');
                    return;
                }
                if (!$('#habit_textArea').val().trim()) {
                    alert('请输入您的喜好!!!');
                    return;
                }
              showOrHiddenLoadingDiv(true);
                /*
                 *进行数据的提交
                 */
                var commitFunc = function () {
                    if (loadAjax)
                        loadAjax.abort();
                    loadAjax = $.ajax({
                        method: 'POST',
                        url: 'http://' + IP + ':' + PORT_PATH + '/userInfo/uploadUserInfo',
                        data: {
                            profile: choiceLogoURL,
                            introduce: '  ' + $('#introduce_self_textarea').val().trim(),
                            habit: '  ' + $('#habit_textArea').val().trim()
                        },
                        dataType: 'text',
                        success: function (data) {
                            showOrHiddenLoadingDiv(false);
                            if (data === mSuccessed) {
                                //进入你的主页面
                                window.location.href = 'http://' + IP + ':' + PORT_PATH + '/owner/ownerMain.html'
                            } else if (data === mFailure) {
                                if (confirm("上传失败，是否重新上传？"))
                                    commitFunc();
                            }
                        }
                    }).fail(function () {
                        showOrHiddenLoadingDiv(false);
                        if (confirm("网络请求失败，是否要重新请求？")) {
                            commitFunc();
                        }
                    });
                };
                //方法调用
                commitFunc();
            }
        }
    })
</script>
</html>